---
title: "Final_project"
author: "Ramy Gadalla"
date: "2022-11-29"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = ""
              )
```


# Analysis of Interaction of Different Cell-types in Human Cancer Tissue Architecture

There is a growing body of compelling evidence in the bio-medical research literature that the cellular composition of human tissue plays major role in the health and disease. That is to say, the type of cells that manage to infiltrate to the tissue microenvironment from the blood circulation dictates the tissue status. Human cancer tissue is characterized in most cases are characterized by infiltration of inflammatory immune cells and unstimulated suppressive immune cells. 

## Objective
Examining the spatial effect of the tumor-infiltrating immune cells distribution in 4 types of cancer tissues (Colorectal cancer, Lung cancer, Breast cancer, Head and neck cancer).

## Data
This data is generated by Imaging Mass Cytometry technique, that enables acquiring information about the expression/distribution of 40 proteins for the same region of interest (ROI) on tissue slide. 

The data is contained in R object of class "spatialexperiment". The data is made of 4 rows, that represent attributes, and 46917 column that represent all the single cells that has been captured by the imaging cytometer.

The "spatialexperiment" class also allows to incorporate data about the row in a slot called "rowData" in a dataframe format and data about columns in a slot called "colData" in a dataframe format. This is a powerful feature that allows for easy subsetting of the data, and easy access to the information. The actual protein expression data is stored in slot called "assays".


Load the necessary libraries for the analysis.
```{r warning=FALSE, message=FALSE, results='hide'}
library(SpatialExperiment)
library(spatstat)
library(imcRtools)
library(cytomapper)
library(ggplot2)
library(viridis)
library(scales)
library(pheatmap)
library(tidyverse)
library(lisaClust)
library(spicyR)
```


Importing the data into R environment
```{r}
spe <- readRDS('./spatial/RDS/spe_celltypeAdded.rd')
spe
```

Exploring the data attributes (which are just numeric value of protein expression)
```{r}
head(rowData(spe))
```
So, the above outcome shows the first six protein in the data (MPO, HistoneH3, SMA, CD16, CD38, HLADR), along with extra information about these proteins or markers, such as the machine channel in which they are acquired,
the molecular clone which were used..etc.

Exploring the column data
```{r}
head(colData(spe))
```

The above results shows only 6 rows out of 46917 rows. Each single cell in the data is represented by row. The above dataframe also shows information about each cell, such as the cell-type, the area, the patient ID..etc.

Exploring the main data
```{r}
assay(spe)[1:4,1:4]
```
The above table shows only few selected columns and rows. The values in this table represents that values of protein expression. 

Explore the spatial data. 
The x,y coordinates for each cell in the data are stored in "spatialCoords" slot.
```{r}
head(spatialCoords(spe))
```


Here is a sample of the images that generated this data.
First, we need to read in two files, the images and the mask (this file is what differentiate between cells and it nucleus, through a process called image segmentation)

```{r  warning=FALSE, message=FALSE, fig.show="hold", fig.align='left'}
images <- readRDS("/Volumes/GoogleDrive/My Drive/spatial/RDS/comp_image_steinbock.rds")
masks <- readRDS("/Volumes/GoogleDrive/My Drive/spatial/RDS/masks.rds")


plotCells(masks['Patient2_s0_a2_ac_ilastik_s2_Probabilities_mask'],
          object = spe, 
          cell_id = "ObjectNumber", img_id = "patient_id",
          colour_by = "celltype")


```

The above photo shows the distribution of different cell-types in the tissue microenvironment one of the participating patient.


## Methods and analysis

Spatial Interaction Graphs

One approach to estimate clustering or interaction frequencies between cell-types is by building a spatial graph object, in which, the graph nodes represent single cells and the edges between the nodes represent the neighborhood.

There are several ways to construct graph from the data.
1-Adjacency
2-knn interaction graph
3-expansion interaction graph
4-Delauny interaction graph



These graphs are stored in slot "colPair" of the "spatialexperiment" object. The Adjacency graph ("neighborhood") comes built in the data (from the image pre-processing pipeline).

```{r}
colPairNames(spe)
```


To add and to try the 3 other graphs, function buildspatialgraph() will be used
```{r}

spe <- buildSpatialGraph(spe, img_id = "sample_id", type = "knn", k = 20)
spe <- buildSpatialGraph(spe, img_id = "sample_id", type = "expansion", threshold = 20)
spe <- buildSpatialGraph(spe, img_id = "sample_id", type = "delaunay", max_dist = 50)
```


Checking if the 3 constructed graphs are added to the data.
```{r}
colPairNames(spe)
```


plotting graphs constructed by Adjacency and Delaunay triangulation

```{r warning=FALSE, message=FALSE, fig.show="hold", out.width="50%", results='hold'}
# Adjacency interaction graph
plotSpatial(spe[,spe$sample_id == "Patient2_001"], 
            node_color_by = "celltype", 
            img_id = "sample_id", 
            draw_edges = TRUE, 
            colPairName = "neighborhood", 
            nodes_first = FALSE, 
            edge_color_fix = "grey") + 
    scale_color_manual(values = metadata(spe)$color_vectors$celltype) +
    ggtitle("Adjacency interaction graph")

# delaunay interaction graph 
plotSpatial(spe[,spe$sample_id == "Patient2_001"], 
            node_color_by = "celltype", 
            img_id = "sample_id", 
            draw_edges = TRUE, 
            colPairName = "delaunay_interaction_graph", 
            nodes_first = FALSE,
            edge_color_fix = "grey") + 
    scale_color_manual(values = metadata(spe)$color_vectors$celltype) +
    ggtitle("Delaunay triangulation interaction graph")

```
In the above figures, cells (nodes) that are in the same neighborhood are connected with edges.

# Interaction Analysis

Interaction analysis focuses on hypothesis testing the pairwise interaction between all cell-types in the dataset.

Per grouping level (e.g., image ID/sample ID), the testInteractions function is based on point pattern modelling of the data and it computes the averaged cell type/cell type interaction count and computes this count against an empirical null distribution which is generated by permuting all cell labels (while maintaining the tissue structure).

```{r}

out <- testInteractions(spe, 
                        group_by = "sample_id",
                        label = "celltype", 
                        colPairName = "neighborhood"
                        )

#Dataframe
head(out, 15)
```

The returned dataframe contain test result per image ID. The pairwise of cell-types being tested can be found in the "from_label" and "to_label" column. If a pair of cell-types are significantly interacting the "sigval" is 1, if the pair of cell-types are sigval is -1, if there are no significant interaction sigval is 0.


To visualize this data, the sigval entries across all images must be calculated, and a heatmap is plotted
```{r warning=FALSE, message=FALSE, fig.show="hold", out.width="50%", results='hold'}

out %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    summarize(sum_sigval = sum(sigval, na.rm = TRUE)) %>%
    ggplot() +
        geom_tile(aes(from_label, to_label, fill = sum_sigval)) +
        scale_fill_gradient2(low = muted("blue"), mid = "white", high = muted("red")) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```


In the above plot, the red tiles indicate pair of cell-types (row and column) that are significantly interacting. On the other hand, the blue tiles indicate cell-types that are significantly avoid each others. White tiles indicate no interaction. 

From the above figure, we can deduce that BnTcells are actively avoiding being in proximity of Meyloid and tumor cells. CD4, plasma cell and Treg are mostly compartmentalized (interacting with tumor cells). Also Bcells tends to sit around CD4 cells.


Another strategy to perform interaction analysis is test the hypothesis if at least n cells of a certain type are located around a target cell type (from_cell). This can be done by adding one more argument to the above function (method = "patch"), and by specifying the patch size

```{r warning=FALSE, message=FALSE, fig.show="hold", out.width="50%", results='hold'}
out <- testInteractions(spe, 
                        group_by = "sample_id",
                        label = "celltype", 
                        colPairName = "neighborhood",
                        method = "patch", 
                        patch_size = 3
                        )

out %>% as_tibble() %>%
    group_by(from_label, to_label) %>%
    summarize(sum_sigval = sum(sigval, na.rm = TRUE)) %>%
    ggplot() +
        geom_tile(aes(from_label, to_label, fill = sum_sigval)) +
        scale_fill_gradient2(low = muted("blue"), mid = "white", high = muted("red")) +
        theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
Results from the above figure are comparable to the previous heatmap. In addition to all the conclusions we can get from the above figure, we can add, for instance, that Bcells not only tend to aggregate around CD4 cells, but in most cases there 3 or more Bcells around CD4. 

# Cellular Neighborhood Analysis

This approach identify cluster of cells based on information contained in their direct neighborhood.
This is carried out by computing the local indicator of spatial autocorrelation function (L-function) and cluster cells based on these values. In other words, the "lisaclust" package summarizes L-functions from a Poisson point process model to derive numeric vectors for each cell which can then again be clustered using kmeans.

```{r}

#preparing for computing LISA curve
cells <- data.frame(row.names = colnames(spe))
cells$ObjectNumber <- spe$ObjectNumber
cells$ImageNumber <- spe$sample_id
cells$AreaShape_Center_X <- spatialCoords(spe)[,"Pos_X"]
cells$AreaShape_Center_Y <- spatialCoords(spe)[,"Pos_Y"]
cells$cellType <- spe$celltype

lisa_sc <- SegmentedCells(cells, cellProfiler = TRUE)


#LISA curve us calculated within 10um, 20um, 50um neighborhood around each cell.
lisaCurves <- lisa(lisa_sc, Rs = c(10, 20, 50))
head(lisaCurves)
```

Then the cells are clustered based on these values by kmeans clustering (k=6 is just a choice).
```{r}
# Set NA to 0
lisaCurves[is.na(lisaCurves)] <- 0

#kmeans clustering, 6 clusters are expected.
lisa_clusters <- kmeans(lisaCurves, centers = 6)$cluster

spe$lisa_clusters <- as.factor(lisa_clusters)

plotSpatial(spe, 
            node_color_by = "lisa_clusters", 
            img_id = "sample_id", 
            node_size_fix = 0.5) +
    scale_color_brewer(palette = "Set3")
```
The above plot shows the neigbhorhoods detected in our dataset, per image.

We can now use heatmap to observe the cell-type composition per spatial cluster/neighborhood.

```{r warning=FALSE, message=FALSE, fig.show="hold", out.width="50%", results='hold'}
for_plot <- colData(spe) %>% as_tibble() %>%
    group_by(lisa_clusters, celltype) %>%
    summarize(count = n()) %>%
    mutate(freq = count / sum(count)) %>%
    pivot_wider(id_cols = lisa_clusters, names_from = celltype, 
                values_from = freq, values_fill = 0) %>%
    ungroup() %>%
    select(-lisa_clusters)

pheatmap(for_plot, color = colorRampPalette(c("dark blue", "white", "dark red"))(100), 
         scale = "column")
```
The above figure shows, the cell-type constituent of each neighborhood we got from LISA clustering the data. For instance, neighborhood 4 is composed mostly from Bcells and CD8 cells, and neighborhood 6 is composed mostly from plasma cells, CD4 cells, Tumor cells.   


# Replicated multivariate point pattern using spatstat

In an attempt to check if each cancer type has distinct point pattern, I used library spatstat feature that allows for fitting model to replicated point pattern (in this case it is patient ID or cancer type/indication, as the data has 4 patients and each patient has different cancer type).

The data needs to be structured a hyperframe object. The next chunck of code achieves this. (I know the code doesn't look pretty and not ideal computationally but because of the time tightness I couldn;t change it)

```{r warning=FALSE, message=FALSE, fig.show="hold", out.width="50%", results='hold'}

#creating a listof object of ppp object. The ppp is marked with cell-types 
X <- listof(
  ppp(spatialCoords(spe[,spe$sample_id=="Patient1_001"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient1_001"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient1_001"])$celltype), 
  ppp(spatialCoords(spe[,spe$sample_id=="Patient1_002"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient1_002"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient1_002"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient1_003"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient1_003"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient1_003"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient2_001"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient2_001"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient2_001"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient2_002"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient2_002"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient2_002"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient2_003"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient2_003"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient2_003"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient2_004"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient2_004"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient2_004"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient3_001"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient3_001"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient3_001"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient3_002"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient3_002"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient3_002"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient3_003"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient3_003"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient3_003"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient4_005"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient4_005"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient4_005"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient4_006"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient4_006"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient4_006"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient4_007"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient4_007"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient4_007"])$celltype),
  ppp(spatialCoords(spe[,spe$sample_id=="Patient4_008"])[,"Pos_X"], spatialCoords(spe[,spe$sample_id=="Patient4_008"])[,"Pos_X"], marks =colData(spe[,spe$sample_id=="Patient4_008"])$celltype)
)
  
 

indication <- c("SCCHN", "SCCHN", "SCCHN",
                "BCC", "BCC", "BCC", "BCC",
                "NSCLC", "NSCLC", "NSCLC",
                "CRC", "CRC", "CRC", "CRC")

Patient_id <- c("patient_1", "patient_1", "patient_1", 
                "patient_2", "patient_2", "patient_2", "patient_2",
                "patient_3", "patient_3", "patient_3",
                "patient_4", "patient_4", "patient_4", "patient_4")

# creating the hyperframe
HF <- hyperframe(point_pattern = X,Patient_id = Patient_id, groups = as.factor(indication))
HF

```

Next, I fit a model to the data in the hyperframe object

```{r}
model_1 <- mppm(point_pattern ~ 0+groups, HF)
summary(model_1)
```
 Given the above data, it seems that cancer type has significant impact of the spatial distribution of the different cell-types.
 
 
Because each patient has 3 or 4 images, and that might be introducing autocorrelation effect, I next fit the model with patient ID as random effect.
 
 
```{r}
model_2 <- mppm(point_pattern ~ 0+groups, HF, random = ~ 1| Patient_id)
model_2
```
 

# Reference

Schürch, Christian M, Salil S Bhate, Graham L Barlow, Darci J Phillips, Luca Noti, Inti Zlobec, Pauline Chu, et al. 2020. “Coordinated Cellular Neighborhoods Orchestrate Antitumoral Immunity at the Colorectal Cancer Invasive Front.” Cell 182: 1341–59.

Schapiro, Denis, Hartland W Jackson, Swetha Raghuraman, Jana R Fischer, Vito RT Zanotelli, Daniel Schulz, Charlotte Giesen, Raúl Catena, Zsuzsanna Varga, and Bernd Bodenmiller. 2017. “histoCAT: Analysis of Cell Phenotypes and Interactions in Multiplex Image Cytometry Data.” Nature Methods 14: 873--876.

Patrick, Ellis, Nicolas P. Canete, Sourish S. Iyengar, Andrew N. Harman, Greg T. Sutherland, and Pengyi Yang. 2021. “Spatial Analysis for Highly Multiplexed Imaging Data to Identify Tissue Microenvironments.” bioRxiv.

